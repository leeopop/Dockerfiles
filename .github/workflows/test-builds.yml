name: Test Builds

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-linux-distros:
    name: Test ${{ matrix.distro }}
    runs-on: ubuntu-latest
    
    concurrency:
      group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}-${{ matrix.distro }}
      cancel-in-progress: true
    
    strategy:
      fail-fast: false
      matrix:
        distro:
          - ubuntu:20.04
          - ubuntu:22.04
          - ubuntu:24.04
          - debian:11
          - debian:12
          - debian:13
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y whois net-tools
          echo "password" | mkpasswd -s > .password
          echo "USER_NAME=testuser" >> $GITHUB_ENV
          echo "SERVICE_HOST=127.0.0.1" >> $GITHUB_ENV
      
      - name: Setup test images
        run: |
          mkdir -p testimage
          # Always put base-image first, then add all other directories except template, scripts, and hidden directories
          echo "base-image" > testimage/.includes
          find . -maxdepth 1 -type d ! -name '.' ! -name '..*' ! -name 'template' ! -name 'scripts' ! -name 'base-image' ! -name 'testimage' -exec basename {} \; | sort >> testimage/.includes
          echo "Test images to build:"
          cat testimage/.includes
      
      - name: Run tests for ${{ matrix.distro }}
        run: |
          export BASE_IMAGE=${{ matrix.distro }}
          ./init_env.sh
          ./generate.sh
          docker build -t testimage:latest -f testimage/Dockerfile .
          echo "Build test passed for ${{ matrix.distro }}!"
  
  ci-success:
    name: CI Success (test-builds)
    runs-on: ubuntu-latest
    needs: test-linux-distros
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.test-linux-distros.result }}" == "success" ]]; then
            echo "✅ All Linux distribution tests passed!"
            exit 0
          else
            echo "❌ Some Linux distribution tests failed"
            exit 1
          fi
